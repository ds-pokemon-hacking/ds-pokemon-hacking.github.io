<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-generation-iv/guides/pt-trainer_code_expansion/pt-trainer_code_expansion" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Optimizing and Expanding Functionality for Trainer Pokemon | DS Pokémon Hacking</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ds-pokemon-hacking.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ds-pokemon-hacking.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ds-pokemon-hacking.github.io/docs/generation-iv/guides/pt-trainer_code_expansion/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Optimizing and Expanding Functionality for Trainer Pokemon | DS Pokémon Hacking"><meta data-rh="true" name="description" content="Author: Lhea"><meta data-rh="true" property="og:description" content="Author: Lhea"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ds-pokemon-hacking.github.io/docs/generation-iv/guides/pt-trainer_code_expansion/"><link data-rh="true" rel="alternate" href="https://ds-pokemon-hacking.github.io/docs/generation-iv/guides/pt-trainer_code_expansion/" hreflang="en"><link data-rh="true" rel="alternate" href="https://ds-pokemon-hacking.github.io/docs/generation-iv/guides/pt-trainer_code_expansion/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Guides","item":"https://ds-pokemon-hacking.github.io/docs/category/guides"},{"@type":"ListItem","position":2,"name":"Optimizing and Expanding Functionality for Trainer Pokemon","item":"https://ds-pokemon-hacking.github.io/docs/generation-iv/guides/pt-trainer_code_expansion/"}]}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.c8c8a929.css">
<script src="/assets/js/runtime~main.7f4f7ac9.js" defer="defer"></script>
<script src="/assets/js/main.041c4eba.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/kodsh.png" alt="DS Pokémon Hacking Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/kodsh.png" alt="DS Pokémon Hacking Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">DS Pokémon Hacking</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/guides">Generation IV</a><a class="navbar__item navbar__link" href="/docs/category/guides-1">Generation V</a><a class="navbar__item navbar__link" href="/docs/category/guides-2">Universal</a><a class="navbar__item navbar__link" href="/contributing">Contributing</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/ds-pokemon-hacking/ds-pokemon-hacking.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/guides">Guides</a><button aria-label="Collapse sidebar category &#x27;Guides&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/hgss-code_injection/">Code Injection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/hgss-new_overworlds/">Adding New Overworlds in HeartGold Engine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/hgss-new_script_commands/">Creating New Script Commands in HeartGold Engine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/hgss-town_map/">Editing the Town Map</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/ncer_sprite_editing/">Cell Editing for Sprites</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/overworld_sprites/">Overworld Sprite Replacement Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/pt-reusable_repel/">Reusable Repel</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/generation-iv/guides/pt-trainer_code_expansion/">Optimizing and Expanding Functionality for Trainer Pokemon</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/pt-type_expansion/">Type Expansion</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/pt_hgss-hp_bar_speed/">Changing the HP bar Speed</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/pt_hgss-pokemarts/">Adding New Poké Marts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/pt_hgss-reusabletms/">Enabling Reusable TMs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/pt_hgss-script_weather/">Setting the Weather From a Script</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/resources">Resources</a><button aria-label="Expand sidebar category &#x27;Resources&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/guides"><span>Guides</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Optimizing and Expanding Functionality for Trainer Pokemon</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_bxCs"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/guide-platinum">Guide (Platinum)</a></li></ul></div></div><div class="theme-doc-markdown markdown"><header><h1>Optimizing and Expanding Functionality for Trainer Pokemon</h1></header>
<blockquote>
<p>Author: Lhea <br>
Credits: Lhea (Platinum implementation), BluRose (original implementation in HG Engine)</p>
</blockquote>
<p>The code used in the generation 4 games for loading Trainer Pokemon from their
data files is poorly-optimized and duplicates much of its own logic. Additionally,
Pokemon Platinum lacks certain functionality that is present in Heart Gold and
Soul Silver:</p>
<ol>
<li>Optimizing friendship on Trainer Pokemon to maximize the damage of Return
and Frustration.</li>
<li>Forcing trainer Pokemon to use Ability 2 instead of Ability 1.</li>
<li>Forcing trainer Pokemon to be a certain gender.</li>
</ol>
<p>Luckily, because of the poor optimization of the original code, we can rewrite
this function to free up additional space for these new functions, as well as
create some new space for additional data or code.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="table-of-contents">Table of Contents<a href="#table-of-contents" class="hash-link" aria-label="Direct link to Table of Contents" title="Direct link to Table of Contents">​</a></h2>
<ul>
<li><a href="#required-tools">Required Tools</a></li>
<li><a href="#code-insertion">Code Insertion</a>
<ul>
<li><a href="#bugfix-alternate-form-stat-recalculation">Bugfix: Alternate Form Stat Recalculation</a></li>
</ul>
</li>
<li><a href="#implementation-caveats">Implementation Caveats</a></li>
<li><a href="#code-breakdown">Code Breakdown</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="required-tools">Required Tools<a href="#required-tools" class="hash-link" aria-label="Direct link to Required Tools" title="Direct link to Required Tools">​</a></h2>
<ul>
<li>DSPRE</li>
<li>A hex editor</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="code-insertion">Code Insertion<a href="#code-insertion" class="hash-link" aria-label="Direct link to Code Insertion" title="Direct link to Code Insertion">​</a></h2>
<ol>
<li>Open the <code>arm9.bin</code> file in your <code>YourROMName_DSPRE_contents</code> folder in your
hex editor of choice.</li>
<li>Navigate to offset <code>0x0793B8</code>.</li>
<li>Paste (overwrite) the next <code>0x0410</code> bytes with the following:</li>
</ol>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">F0 B5 93 B0 0C 1C 07 1C 04 92 A3 F7 85 FF 0D 90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A0 00 06 90 C0 19 40 68 06 21 00 F0 1F FE 04 98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6C 21 9E F7 B3 FE 10 90 04 98 FA F7 47 FC 06 1C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">06 98 C0 19 80 69 10 99 FF F7 D4 FF 34 20 60 43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">05 90 C0 19 29 30 00 78 FF F7 D4 FF 01 28 01 D1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">78 20 00 E0 88 20 12 90 05 98 C0 19 01 1C 28 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2B 31 00 78 09 78 00 22 0F 92 00 29 00 DC 96 E0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">06 99 C9 19 0C 91 02 21 01 40 0B 91 01 21 01 40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0A 91 10 9D 28 78 6A 78 09 90 E8 78 01 02 A8 78</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">08 43 08 90 68 79 01 02 28 79 08 43 AD 1D 45 49</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">01 40 07 91 80 12 11 A9 08 70 01 1C 07 98 12 AB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00 F0 9A F8 09 99 08 98 09 18 07 98 09 18 0C 98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">80 69 40 18 0E 90 A3 F7 2D FF 05 98 C0 19 29 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00 78 00 24 00 28 09 DD A3 F7 2A FF 0E 90 64 1C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">05 98 C0 19 29 30 00 78 84 42 F5 DB 0E 98 01 02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">12 98 0C 18 09 99 1F 20 48 43 FF 21 68 F0 5A ED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">03 1C 01 20 00 90 01 94 02 20 02 90 00 20 03 90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">30 1C 07 99 08 9A FA F7 57 FC 0B 98 00 28 0B D0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">68 78 01 02 28 78 01 43 AD 1C 11 AA 02 32 11 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">30 1C 06 21 FB F7 20 FB 0A 98 00 28 0C D0 00 24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">68 78 01 02 28 78 01 43 AD 1C 30 1C 22 1C FD F7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">97 FE 64 1C 04 2C F3 DB 30 1C 00 F0 2D F8 68 78</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">01 02 28 78 08 43 AD 1C 31 1C 04 9A FF F7 E2 FA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">30 1C 70 21 11 AA FB F7 FF FA C0 46 C0 46 C0 46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0C 98 40 68 31 1C 00 F0 83 FD 05 98 C0 19 2B 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">01 78 0F 98 40 1C 0F 90 88 42 00 DA 72 E7 10 98</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9E F7 34 FE 30 1C 9E F7 31 FE 0D 98 A3 F7 BA FE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">13 B0 F0 BD FF 03 00 00 F8 B5 05 1C 00 24 FF 27</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">36 23 28 1C 21 1C C9 18 00 22 FA F7 75 FF DA 28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00 D1 00 27 64 1C 04 2C F3 DB 28 1C 09 21 6A 46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">17 70 FB F7 C9 FA F8 BD F0 B5 1D 1C 0F 23 13 40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1E 1C 14 09 00 2A 15 D0 00 2E 08 D0 12 22 FC F7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">09 FA 01 2E 01 D1 80 1C 00 E0 80 1E 28 60 01 2C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">03 D1 01 21 88 43 28 60 F0 BD 02 2C 02 D1 01 21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">08 43 28 60 F0 BD 00 00 FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FF FF FF FF FF FF FF FF 48 BA 48 19 4C 48 45 41</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bugfix-alternate-form-stat-recalculation">Bugfix: Alternate Form Stat Recalculation<a href="#bugfix-alternate-form-stat-recalculation" class="hash-link" aria-label="Direct link to Bugfix: Alternate Form Stat Recalculation" title="Direct link to Bugfix: Alternate Form Stat Recalculation">​</a></h3>
<p>This section is included as optional for those who wish to maintain the
vanilla quirks of generation 4 games.</p>
<p>Generation 4 Pokemon games fail to recalculate the stats of trainer Pokemon
which are using an alternate form. This results in Pokemon such as Wormadam-Sandy
using incorrect stats, as they still reflect the stats of its base form.</p>
<p>Space is included in the above code insertion to fix this bug. With your <code>arm9.bin</code>
open in your hex editor:</p>
<ol>
<li>Navigate to <code>0x079532</code>. You should see the bytes <code>C0 46 C0 46 C0 46</code>.</li>
<li>Replace these bytes with <code>30 1C FA F7 40 FE</code>.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-caveats">Implementation Caveats<a href="#implementation-caveats" class="hash-link" aria-label="Direct link to Implementation Caveats" title="Direct link to Implementation Caveats">​</a></h2>
<p>As with its similar implementation in Heart Gold, the usual caveats when modifying
trainer Pokemon apply.</p>
<ol>
<li>When setting a given Pokemon in a trainer&#x27;s team to use Ability 2, all Pokemon
in later team slots will <em>also</em> use Ability 2 until one of them is explicitly
flagged to use Ability 1.</li>
<li>When setting a given Pokemon to be forced Male or Female, that Pokemon will
implicitly be flagged to have Ability 2 <em>unless</em> the Pokemon&#x27;s species is
configured to be Male-only or Female-only (e.g., Nidoking, Miltank). This also
applies to Pokemon species which are genderless (e.g., Mewtwo, Magneton): any
such Pokemon having a flag to set it to Male or Female would give it Ability 2,
if applicable.</li>
</ol>
<p>As an illustration of these caveats, consider the following enemy trainer teams
with no modifications to the species data structures:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Lucario   - no flags set        &lt;- has Steadfast (Ability 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Breloom   - Ability 2 flag set  &lt;- has Poison Heal (Ability 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kingdra   - no flags set        &lt;- has Sniper (Ability 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Swampert  - no flags set        &lt;- has Torrent (only valid Ability)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Machamp   - Ability 1 flag set  &lt;- has Guts (Ability 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Magnezone - Male flag set       &lt;- has Sturdy (Ability 2)</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Scizor     - Ability 2 flag set  &lt;- has Technician (Ability 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rotom-Heat - no flags set        &lt;- has Levitate (only valid Ability)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tauros     - no flags set        &lt;- has Anger Point (Ability 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Miltank    - Female flag set     &lt;- has Thick Fat (Ability 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Flygon     - Male flag set       &lt;- has Levitate (only valid Ability)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Gliscor    - no flags set        &lt;- has Sand Veil (Ability 2)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="code-breakdown">Code Breakdown<a href="#code-breakdown" class="hash-link" aria-label="Direct link to Code Breakdown" title="Direct link to Code Breakdown">​</a></h2>
<p>This section is purely for illustrative and educational purposes by explaining
the code that we just inserted. The full ARMIPS file used to generate the above
code is available on my GitHub <a href="https://github.com/lhearachel/pokeplat-trainer-expansion/blob/main/trainer_data_build_party.s" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>The <a href="https://github.com/pret/pokeplatinum/blob/main/src/trainer_data.c#L179" target="_blank" rel="noopener noreferrer">vanilla routine</a>
makes use of duplicated code across multiple <code>case</code> branches of a <code>switch</code> block,
which results in bloated code space; the compiled function consumes 1,040 bytes
of ROM space. However, a few interesting quirks of the trainer Pokemon structure
work in our favor for optimizing this routine:</p>
<ol>
<li>The trainer Pokemon data is loaded all at once as a raw memory buffer without
statically defined boundaries.</li>
<li>At runtime, the game evaluates the trainer&#x27;s <code>type</code> field to determine how
it should interpret this buffer. This <code>type</code> field has four possible values,
and the layout of these values means we can interpret them as a bitmask:</li>
</ol>
<table><thead><tr><th style="text-align:right"><code>type</code></th><th>Meaning</th></tr></thead><tbody><tr><td style="text-align:right"><code>0</code></td><td>The trainer&#x27;s Pokemon have no special properties.</td></tr><tr><td style="text-align:right"><code>1</code></td><td>The trainer&#x27;s Pokemon define their known moves.</td></tr><tr><td style="text-align:right"><code>2</code></td><td>The trainer&#x27;s Pokemon define their held items.</td></tr><tr><td style="text-align:right"><code>3</code></td><td>The trainer&#x27;s Pokemon define both their held items and their known moves.</td></tr></tbody></table>
<p>With these factors in mind, we can rewrite this jump table implementation as a
simple loop which chomps through the loaded memory buffer by-byte. C code for
this re-implementation is given below:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">CHOMP_U16</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">buf</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">        </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">buf</span><span class="token macro property expression punctuation" style="color:#393A34">[</span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token macro property expression punctuation" style="color:#393A34">]</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">&lt;&lt;</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">8</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">|</span><span class="token macro property expression" style="color:#36acaa"> buf</span><span class="token macro property expression punctuation" style="color:#393A34">[</span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">]</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression" style="color:#36acaa">buf </span><span class="token macro property expression operator" style="color:#393A34">+=</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TrainerMon_SetFriendship</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pokemon </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mon</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TrainerMon_CheckOverrideFlags</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u16 species</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> u8 form</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> u8 flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> u32 </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pidMod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TrainerData_BuildParty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BattleParams </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">battleParams</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> battler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> heapID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 oldSeed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">LCRNG_GetSeed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Party_InitWithCapacity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">battleParams</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">parties</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">battler</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MAX_PARTY_SIZE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">buf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Heap_AllocFromHeap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">heapID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TrainerMonWithMovesAndItem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> MAX_PARTY_SIZE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Pokemon </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mon </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Pokemon_New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">heapID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">TrainerData_LoadParty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">battleParams</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">trainerIDs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">battler</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 pidMod </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TrainerClass_Gender</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">battleParams</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">trainerData</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">battler</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> GENDER_FEMALE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">120</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">136</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u8 trainerFlags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> battleParams</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">trainerData</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">battler</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u8 </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">cursor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u8 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> battleParams</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">trainerData</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">battler</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">partySize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u16 dv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CHOMP_U16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cursor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u16 level </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CHOMP_U16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cursor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u16 monID </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CHOMP_U16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cursor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u16 species </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> monID </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x03FF</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// least-significant 10 bits</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 form </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> monID </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// most-significant 6 bits</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u32 rnd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dv </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> level </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> species </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> battleParams</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">trainerIDs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">battler</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">LCRNG_SetSeed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rnd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> battleParams</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">trainerData</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">battler</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">class</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rnd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">LCRNG_Next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rnd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rnd </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> pidMod</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u8 ivs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dv </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> MAX_IVS_SINGLE_STAT </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> MAX_DV</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Pokemon_InitWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mon</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> species</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> level</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ivs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TRUE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rnd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> OTID_NOT_SHINY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">trainerFlags </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> TRDATATYPE_WITH_ITEM</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            u16 item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CHOMP_U16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cursor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">Pokemon_SetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mon</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MON_DATA_HELD_ITEM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">trainerFlags </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> TRDATATYPE_WITH_MOVES</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">j </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> LEARNED_MOVES_MAX</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                u16 move </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CHOMP_U16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cursor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">Pokemon_SetMoveSlot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mon</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> move</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> j</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u16 cbSeal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CHOMP_U16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cursor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Pokemon_SetBallSeal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cbSeal</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mon</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> heapID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Pokemon_SetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mon</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MON_DATA_FORM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">form</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Party_AddPokemon</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">battleParams</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">parties</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">battler</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mon</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Heap_FreeToHeap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Heap_FreeToHeap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mon</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">LCRNG_SetSeed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldSeed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>This reduces the routine to a much slimmer size and gives us plenty of free
space for back-porting the new features for trainer Pokemon from Heart Gold.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ds-pokemon-hacking/ds-pokemon-hacking.github.io/docs/generation-iv/guides/pt-trainer_code_expansion/pt-trainer_code_expansion.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_VsjB"></div></div></footer></article><nav class="pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/generation-iv/guides/pt-reusable_repel/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Reusable Repel</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/generation-iv/guides/pt-type_expansion/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Type Expansion</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#table-of-contents" class="table-of-contents__link toc-highlight">Table of Contents</a></li><li><a href="#required-tools" class="table-of-contents__link toc-highlight">Required Tools</a></li><li><a href="#code-insertion" class="table-of-contents__link toc-highlight">Code Insertion</a><ul><li><a href="#bugfix-alternate-form-stat-recalculation" class="table-of-contents__link toc-highlight">Bugfix: Alternate Form Stat Recalculation</a></li></ul></li><li><a href="#implementation-caveats" class="table-of-contents__link toc-highlight">Implementation Caveats</a></li><li><a href="#code-breakdown" class="table-of-contents__link toc-highlight">Code Breakdown</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 DS Pokémon Hacking. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>