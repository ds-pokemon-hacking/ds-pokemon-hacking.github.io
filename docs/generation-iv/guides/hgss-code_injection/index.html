<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-generation-iv/guides/hgss-code_injection/hgss-code_injection" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">Code Injection | DS Pokémon Hacking</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ds-pokemon-hacking.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ds-pokemon-hacking.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ds-pokemon-hacking.github.io/docs/generation-iv/guides/hgss-code_injection/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Code Injection | DS Pokémon Hacking"><meta data-rh="true" name="description" content="Author(s): BluRose."><meta data-rh="true" property="og:description" content="Author(s): BluRose."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ds-pokemon-hacking.github.io/docs/generation-iv/guides/hgss-code_injection/"><link data-rh="true" rel="alternate" href="https://ds-pokemon-hacking.github.io/docs/generation-iv/guides/hgss-code_injection/" hreflang="en"><link data-rh="true" rel="alternate" href="https://ds-pokemon-hacking.github.io/docs/generation-iv/guides/hgss-code_injection/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Guides","item":"https://ds-pokemon-hacking.github.io/docs/category/guides"},{"@type":"ListItem","position":2,"name":"Code Injection","item":"https://ds-pokemon-hacking.github.io/docs/generation-iv/guides/hgss-code_injection/"}]}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.83da81f0.css">
<script src="/assets/js/runtime~main.b61456c8.js" defer="defer"></script>
<script src="/assets/js/main.e3713717.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/kodsh.png" alt="DS Pokémon Hacking Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/kodsh.png" alt="DS Pokémon Hacking Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">DS Pokémon Hacking</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/guides">Generation IV</a><a class="navbar__item navbar__link" href="/docs/category/guides-1">Generation V</a><a class="navbar__item navbar__link" href="/docs/category/guides-2">Universal</a><a class="navbar__item navbar__link" href="/contributing">Contributing</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/ds-pokemon-hacking/ds-pokemon-hacking.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/docs/category/guides"><span title="Guides" class="categoryLinkLabel_W154">Guides</span></a><button aria-label="Collapse sidebar category &#x27;Guides&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/getting_started/"><span title="Getting Started" class="linkLabel_WmDU">Getting Started</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/hgss-a3i5_a5i3_materials_and_darkness/"><span title="Translucent Textures with Darkness Weather" class="linkLabel_WmDU">Translucent Textures with Darkness Weather</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/generation-iv/guides/hgss-code_injection/"><span title="Code Injection" class="linkLabel_WmDU">Code Injection</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/hgss-new_overworlds/"><span title="Adding New Overworlds in HeartGold Engine" class="linkLabel_WmDU">Adding New Overworlds in HeartGold Engine</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/hgss-new_script_commands/"><span title="Creating New Script Commands in HeartGold Engine" class="linkLabel_WmDU">Creating New Script Commands in HeartGold Engine</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/hgss-town_map/"><span title="Editing the Town Map" class="linkLabel_WmDU">Editing the Town Map</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/generation-iv/guides/mapping/"><span title="Mapping Overview" class="categoryLinkLabel_W154">Mapping Overview</span></a><button aria-label="Expand sidebar category &#x27;Mapping Overview&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/ncer_sprite_editing/"><span title="Cell Editing for Sprites" class="linkLabel_WmDU">Cell Editing for Sprites</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/overworld_sprites/"><span title="Overworld Sprite Replacement Guide" class="linkLabel_WmDU">Overworld Sprite Replacement Guide</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/pt-reusable_repel/"><span title="Reusable Repel" class="linkLabel_WmDU">Reusable Repel</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/pt-trainer_code_expansion/"><span title="Optimizing and Expanding Functionality for Trainer Pokemon" class="linkLabel_WmDU">Optimizing and Expanding Functionality for Trainer Pokemon</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/pt-type_expansion/"><span title="Type Expansion" class="linkLabel_WmDU">Type Expansion</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/pt_hgss-hp_bar_speed/"><span title="Changing the HP bar Speed" class="linkLabel_WmDU">Changing the HP bar Speed</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/pt_hgss-pokemarts/"><span title="Adding New Poké Marts" class="linkLabel_WmDU">Adding New Poké Marts</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/pt_hgss-reusabletms/"><span title="Enabling Reusable TMs" class="linkLabel_WmDU">Enabling Reusable TMs</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/generation-iv/guides/pt_hgss-script_weather/"><span title="Setting the Weather From a Script" class="linkLabel_WmDU">Setting the Weather From a Script</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/category/resources"><span title="Resources" class="categoryLinkLabel_W154">Resources</span></a><button aria-label="Expand sidebar category &#x27;Resources&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/guides"><span>Guides</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Code Injection</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_bxCs"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/guide-heart-gold">Guide (HeartGold)</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/tags/guide-soul-silver">Guide (SoulSilver)</a></li></ul></div></div><div class="theme-doc-markdown markdown"><div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin:1rem 0"><button style="padding:0.5rem 1rem;border-radius:8px;border:1px solid var(--ifm-color-primary);background:var(--ifm-color-primary);color:#fff;cursor:pointer;flex-shrink:0">← Back</button></div><header><h1>Code Injection</h1></header>
<blockquote>
<p>Author(s): <a href="https://github.com/BluRosie" target="_blank" rel="noopener noreferrer">BluRose</a>.
Research: <a href="https://github.com/BluRosie" target="_blank" rel="noopener noreferrer">BluRose</a>, Touched, and <a href="https://github.com/Skeli789/" target="_blank" rel="noopener noreferrer">Skeli</a> for the original GBA scripts.</p>
</blockquote>
<p>This is an overall code injection guide and explanation behind the code injection framework for HeartGold and SoulSilver.  The template repository can be easily adapted to the rest of the Gen 4 games as long as there is a synthetic overlay definition.</p>
<p>Assembly will not be covered here.  It is recommended you understand assembly code and just basic coding in general before reading this.  There are plenty of tutorials out there for this.  One focused on the NDS that somewhat assumes any programming knowledge (which you&#x27;d need to know to inject code you&#x27;ve written to begin with) is Mikelan&#x27;s overview which can be downloaded <a href="/assets/files/asm1-dfe448d0629040cb8da4ced54a0ed182.pdf" target="_blank">here</a>.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="table-of-contents">Table of Contents<a href="#table-of-contents" class="hash-link" aria-label="Direct link to Table of Contents" title="Direct link to Table of Contents" translate="no">​</a></h2>
<ul>
<li><a href="#manual-process">Manual Process</a></li>
<li><a href="#shortcomings-of-the-manual-process">Shortcomings of the Manual Process</a></li>
<li><a href="#implementation-details">Implementation Details</a>
<ul>
<li><a href="#hooks"><code>hooks</code></a></li>
<li><a href="#bytereplacement"><code>bytereplacement</code></a></li>
<li><a href="#routinepointers"><code>routinepointers</code></a></li>
<li><a href="#repoints"><code>repoints</code></a></li>
</ul>
</li>
<li><a href="#code-injection-template">Code Injection Template</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="manual-process">Manual Process<a href="#manual-process" class="hash-link" aria-label="Direct link to Manual Process" title="Direct link to Manual Process" translate="no">​</a></h2>
<p>The Nintendo DS has 4 MB of EWRAM.  Unlike the GBA, the ROM is not directly mapped and readable in memory.  Files must be dumped into that 4 MB of memory in order to be accessed.  This includes all code that is run--the processor CPU&#x27;s don&#x27;t have direct access to the ROM in code execution space.</p>
<p>The way that was strongarmed by Nintendo onto developers is an overlay system.  This supports swapping out code as it is needed, but statically:  the overlays are not relocatable.  Special care must be taken to define game states, what code is all needed, and when it is needed.</p>
<p>The idea behind code injection is that the normal code execution is highjacked and brought to our code.  The ARM9 binary is constantly loaded in to the memory as something that is constant, and largely includes code that is common between every situation possible.</p>
<p>The way you&#x27;d typically go about this is by manually assembling instructions using an assembler like <code>as</code> of the GNU <code>arm-none-eabi</code> toolset.  This then gives us an output binary that we can paste somewhere using something like <a href="https://pokehacking.com/tutorials/ramexpansion/" target="_blank" rel="noopener noreferrer">Mikelan&#x27;s synthetic overlay implementation</a>, which gives a file that can be used to load in code that serves as an extension of the existing code memory regions.</p>
<p>An example of this in action is in the code edits by <a href="https://twitter.com/AdAstra_GL" target="_blank" rel="noopener noreferrer">AdAstraGL</a> to <a href="https://pastebin.com/eCvYDcyw" target="_blank" rel="noopener noreferrer">speed up the HP bar in HeartGold and Platinum</a>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1) Paste this at 0x14FF0 of your synthetic overlay file:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000   2D 2D 48 50 20 42 41 52 20 53 50 45 45 44 2D 2D   --HP BAR SPEED--</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0010   80 21 49 00 48 43 11 1C 70 47 C0 46 FF FF FF FF   €!I.HC..pGÀFÿÿÿÿ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2) Paste this at offset 0x2E17A of an uncompressed overlay12.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">77 F1 D1 FA</span><br></span></code></pre></div></div>
<p>From the synthetic overlay, the code is dumped to 0x023C8000 in the EWRAM (as implemented by Mikelan).  This places the data we just wrote at <code>0x023C8000 + 0x14FF0 = 0x023DCFF0</code> in the EWRAM.</p>
<p>Overlay 12 is loaded in at 0x022378C0 in EWRAM.  The code at 0x2E17A of overlay 12 is at <code>0x022378C0 + 0x2E17A = 0x02265A3A</code>.</p>
<p>Dumping Overlay 12 into IDA Pro and making an IDB (or using the one from the IDB&#x27;s that I maintain <a href="https://mega.nz/folder/nuhlULbZ#6nbkKtNLXAkTndcRAVtltA" target="_blank" rel="noopener noreferrer">here</a> ) will give this as the code dump near that area:</p>
<p><img decoding="async" loading="lazy" src="/assets/images/loc_2265A36-9b1d03f18d2f212379a0161f2c3190fe.png" width="834" height="330" class="img_ev3q"></p>
<p>The code at <code>0x02265A3A</code> is the code that is already run (because it&#x27;s in the game&#x27;s code already), so we start from there.  The instruction there is changed to this:</p>
<p><img decoding="async" loading="lazy" src="/assets/images/loc_2265A36_edited-606ee1475b3c9c479f91cf6f461b7e14.png" width="754" height="314" class="img_ev3q"></p>
<p>This jumps directly to the code that we just inserted at <code>0x023DCFF0</code>--the second line at <code>0x023DD000</code>, to be exact.</p>
<p>From there, the code at <code>0x023DD000</code> (as dumped by REBot in KoDSH):</p>
<div class="language-arm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-arm codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">movs r1, #0x80   ; +0 = 80 21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lsls r1, r1, #1  ; +2 = 49 00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">muls r0, r1, r0  ; +4 = 48 43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adds r1, r2, #0  ; +6 = 11 1c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bx   lr          ; +8 = 70 47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov  r8, r8      ; +10 = c0 46</span><br></span></code></pre></div></div>
<p>As AdAstra explains in the tutorial, this allows for a coarser control that isn&#x27;t just a multiplier on the original speed of the HP bar (when it&#x27;s depleting).  As it introduces more instructions in place of the older set, there is a need for space elsewhere to insert this bit of code.</p>
<p>The first line inserted--literally <code>--HP BAR SPEED--</code> in ASCII--is just a marker that they insert to help you keep track of what in your synthetic overlay is already managed.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="shortcomings-of-the-manual-process">Shortcomings of the Manual Process<a href="#shortcomings-of-the-manual-process" class="hash-link" aria-label="Direct link to Shortcomings of the Manual Process" title="Direct link to Shortcomings of the Manual Process" translate="no">​</a></h2>
<p><strong>Note that this is not a diss or anything on AdAstra and/or his tutorial.</strong>  This is just a presentation to describe the process that we are looking to automate for code injection.</p>
<p>Manual insertion of this is tedious.
The manual insertion process also mandates that you keep track of things in your synthetic overlay as it fills up--which is where that marker comes in as a reminder when the user is scrolling through their code binaries and forgets what each bit of otherwise-meaningless hexadecimal is.
Sharing this with other people places this smack-dab in the middle of their synthetic overlays and cuts down on continuous free space that they may want to use for other things.  It will require reverse engineering to move this elsewhere, if they even remember the change in the game code that redirected execution out to this point.</p>
<p>The idea with code injection frameworks is to cut down on the manual hex editing and allow code to be shared for insertion at any point in code expansion areas--wherever there is free memory at any given point.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-details">Implementation Details<a href="#implementation-details" class="hash-link" aria-label="Direct link to Implementation Details" title="Direct link to Implementation Details" translate="no">​</a></h2>
<p>When assembling and compiling code, an object file is produced.  This can then be linked to specific addresses to create a linked object of a number of direct compiled objects that are all together.  We can view these addresses, parse the symbol output with Python, and correlate it with our own custom format (also parsed by Python) that will fully automate the overlay process for us--all we have to edit is the code.</p>
<p>This does not eliminate the reverse engineering step required to <em>find</em> exactly where to branch out of the game code to our code.  There is no tutorial for that--you just have to get into the weeds of the assembly directly and figure out what each piece of code is doing.  This is where the GDB Debugger in Desmume coupled with IDA Pro or Ghidra is useful--you can see exactly what is executing and when, trace it to identify what you need to do.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hooks"><code>hooks</code><a href="#hooks" class="hash-link" aria-label="Direct link to hooks" title="Direct link to hooks" translate="no">​</a></h3>
<p>The method chosen to decide how to highjack the game&#x27;s execution is by writing hooks in the binary automatically based on a text file we create and parse.  The hook code is designed to be generic:</p>
<div class="language-arm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-arm codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ldr rN, =functionOffset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bx rN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.pool</span><br></span></code></pre></div></div>
<p>We can insert C code to replace entire functions this way.  In this example, we&#x27;ll use <code>PocketCompaction</code> from hg-engine&#x27;s <a href="https://github.com/BluRosie/hg-engine/blob/main/src/bag.c" target="_blank" rel="noopener noreferrer"><code>src/bag.c</code></a>.  We know this is an equivalent implementation due to the <a href="https://github.com/pret/pokeheartgold/blob/master/src/bag.c#L280" target="_blank" rel="noopener noreferrer">pokeheartgold decompiled code</a>.:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">PocketCompaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ITEM_SLOT </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">slots</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> u32 count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> j</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> count </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">j </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">slots</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantity </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">SwapItemSlots</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">slots</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">slots</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">j</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>This gives an 8-byte snippet of assembly (or 10 bytes if not 4-byte word aligned, which is automatically accounted for) that allows us to jump from any point in EWRAM to any other point in EWRAM.</p>
<p>The hook format as implemented is as follows:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># overlayId symbolName memAddress regId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># i.e.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">arm9 PocketCompaction 080785A0 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0001 FUN_ReadEntryDataArc 021FB164 3</span><br></span></code></pre></div></div>
<p>If the <code>memAddress</code> starts with <code>08</code>, the hook is inserted at the direct file offset of the uncompressed binary, i.e. directly at <code>memAddress &amp; 0xFFFFFF</code>.  If the <code>memAddress</code> starts with <code>02</code>, it is understood as an address in EWRAM, and the NDS overlay table is read to determine where <code>overlayId</code> is loaded in so that the code binary can be written to.</p>
<p>Here, the arm9 <code>memAddress</code> entry for <code>PocketCompaction</code> starts with <code>08</code> so the arm9 binary is opened and the hook is directly inserted at file offset <code>0x785A0</code>.  Then overlay 1 is opened and <code>memAddress</code> starts with <code>02</code> so the script knows that this is a memory offset.  It parses the overlay table (in y9.bin), sees that overlay 1 starts at <code>0x021E5900</code>, and inserts a hook at the file offset <code>0x021FB164 - 0x021E5900 = 0x15864</code> of overlay 1.</p>
<p>After compiling a C file or assembling an assembly file, a compiled object is output.  A compiled object can be passed through a linker (here the standard <code>ld</code>) to produce a linked object.</p>
<p>The direct output of <code>nm linked_object.o</code> gives the addresses of all the functions and data inside of <code>linked_object.o</code>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">023d88cf T PocketCompaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">023d873d T Pocket_GetItemSlotForAdd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">023dcbf0 T Pocket_GetItemSlotForAdd_hook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">023dcc08 t Pocket_GetItemSlotForAdd_return_address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">023d87c9 T Pocket_GetItemSlotForRemove</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">023dcc60 T Pocket_GetItemSlotForRemove_hook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">023dcc78 t Pocket_GetItemSlotForRemove_return_address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">023d88ab T Pocket_GetQuantity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">023d891d T Pocket_TakeItem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">023dccb4 T Pocket_TakeItem_hook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">023dcccc t Pocket_TakeItem_return_address</span><br></span></code></pre></div></div>
<p>We use Python to parse this output from <code>nm</code> and create a &quot;symbol table&quot; of sorts that shows where code we put in the ROM will eventually be loaded into the EWRAM.  We can finally use all of this to write the hooks directly.</p>
<p>In this example, the <code>PocketCompaction</code> function is seen at <code>023D88CF</code> in the EWRAM, so the code below is written to <code>0x785A0</code> of the arm9 binary (as specified by <code>080785A0</code> in the hook entry):</p>
<div class="language-arm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-arm codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ldr r2, =0x023D88CF // PocketCompaction&#x27;s offset in memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bx r2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.pool // gets expanded to CF 88 3D 02 as it stores the ldr value above</span><br></span></code></pre></div></div>
<p>Which automatically puts <code>00 4A 10 47 CF 88 3D 02</code> at <code>0x785A0</code> of the arm9 binary.  This highjacks the code execution directly to our version of <code>PocketCompaction</code>, effectively <em>replacing the function entirely with whatever code we write</em>.</p>
<p>You do not need to replace an entire function at its start.  You can branch out of the middle of a function, write purely assembly code to tweak a register&#x27;s value, or write a custom hook as a landing pad from the code binary to tweak certain registers and restore values before passing everything back to the game to run proper.</p>
<ul>
<li>Note for functions that have more than 3 arguments:  The C standard for ARM stipulates that arguments 0-3 are passed as <code>r0</code>-<code>r3</code> in the resulting assembly.  Further arguments are passed via the stack.  To deal with this, we write a custom hook including some <code>bytereplacement</code> elements that maintains all of the registers and stack pointer going into the function from the ROM.  See the <a href="https://github.com/search?q=repo%3ABluRosie%2Fhg-engine%20CantEscape&amp;type=code" target="_blank" rel="noopener noreferrer"><code>CantEscape</code> example</a> for implementation details.</li>
</ul>
<p>Further convenience is afforded in these files that Python parses with <code>bytereplacement</code>, <code>routinepointers</code>, and <code>repoints</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bytereplacement"><code>bytereplacement</code><a href="#bytereplacement" class="hash-link" aria-label="Direct link to bytereplacement" title="Direct link to bytereplacement" translate="no">​</a></h3>
<p><code>bytereplacement</code> writes a stream of bytes to an offset specified in the code binary of the ROM (with the same <code>08</code>/<code>02</code> file offset/memory offset handling):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># pokewalker species limiters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0112 021ED63C FF 7F 00 00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0112 021ED668 FF 7F 00 00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0112 021EFB10 FF 7F 00 00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0112 021F126C FF 7F 00 00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0112 021F323C FF 7F 00 00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#Binding moves 1/8th</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0012 08012852 08</span><br></span></code></pre></div></div>
<p>Here, overlay 112 has a number of memory offsets overwritten with <code>FF 7F 00 00</code>.  All of these files take lines that start with <code>#</code> as comments that can be discarded (outside of <code>#ifdef</code> conditional inclusion).
Overlay 12 has <code>08</code> directly written to file offset <code>0x12852</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="routinepointers"><code>routinepointers</code><a href="#routinepointers" class="hash-link" aria-label="Direct link to routinepointers" title="Direct link to routinepointers" translate="no">​</a></h3>
<p><code>routinepointers</code> will place a pointer to a function at an offset specified in the code binary of the ROM (with the same <code>08</code>/<code>02</code> file offset/memory offset handling).  This automatically accounts for thumb if it is compiled as such--the offset written will have 1 added to it if necessary.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0012 BGCallback_Waza_Extend 08037084</span><br></span></code></pre></div></div>
<p>This places a pointer to the code symbol <code>BGCallback_Waza_Extend</code> at file offset <code>0x37084</code> of overlay 12.  This is automatically adjusted for thumb mode if necessary.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="repoints"><code>repoints</code><a href="#repoints" class="hash-link" aria-label="Direct link to repoints" title="Direct link to repoints" translate="no">​</a></h3>
<p>And <code>repoints</code> will place a pointer to any data you specify in the code in the code binary of the ROM (with the same <code>08</code>/<code>02</code> file offset/memory offset handling):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># repoint the type effectiveness table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0012 TypeEffectivenessTable+1 02251D20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0012 TypeEffectivenessTable+2 02251D24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0012 TypeEffectivenessTable 0225204C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0012 TypeEffectivenessTable 02252174</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0012 TypeEffectivenessTable+1 022521C0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0012 TypeEffectivenessTable+2 022521C4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0012 TypeEffectivenessTable 02252640</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0012 TypeEffectivenessTable+1 02252644</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0012 TypeEffectivenessTable+2 02252648</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0012 TypeEffectivenessTable 02252694</span><br></span></code></pre></div></div>
<p><code>repoints</code> is unique in that it lets you specify an offset to be added to the pointer before writing it to the code binaries.  This is done to mimic how the compiler handles optimizations at times by inserting a reference to a table that is offset by the position of the entry it needs.</p>
<p>In this example, <code>TypeEffectivenessTable</code> is a list of <code>u8</code> arrays with declaration <code>u8 TypeEffectivenessTable[][3];</code>.  Each 3 bytes is in the order of attacking type, defending type, and effectiveness multiplier.  Code that only references the effectiveness multiplier may be optimized by the compiler to directly build that offset into the reference it generates (and does), so we allow the option to compensate for that here.</p>
<p>It is also possible to use functions and data from the ROM itself.  The code injection framework achieves this by defining symbol offsets in <a href="https://github.com/BluRosie/hg-transparent-textbox/blob/main/rom.ld" target="_blank" rel="noopener noreferrer"><code>rom.ld</code></a>.  Here we can add a function from the ROM, say <code>DaycareMon_GetBoxMon</code> which according to the <a href="https://raw.githubusercontent.com/pret/pokeheartgold/xmap/heartgoldus.xMAP" target="_blank" rel="noopener noreferrer"><code>xmap</code></a> is located at <code>020292E4</code> in the arm9.  To use this, we add an entry to <a href="https://github.com/BluRosie/hg-transparent-textbox/blob/main/rom.ld" target="_blank" rel="noopener noreferrer"><code>rom.ld</code></a>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DaycareMon_GetBoxMon = 0x020292E4 | 1;</span><br></span></code></pre></div></div>
<p>The <code>0x020292E4</code> is the base offset of the function.  The <code>| 1</code> is due to the function being in thumb mode (as most functions from the ROM are), a reduced instruction set of ARM that permits much smaller code generation.</p>
<p>To then call this in our code, we have to add a declaration of the function (its structures, <code>BoxPokemon</code> and <code>DaycareMon</code> will have to be copied as well):</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">BoxPokemon </span><span class="token operator" style="color:#393A34">*</span><span class="token function" style="color:#d73a49">DaycareMon_GetBoxMon</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DaycareMon </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dcmon</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>When we do this alone, the linker assumes the function is ARM and resolves the address of the function to be <code>0x020292E4</code>, jumping to it with a <code>blx</code> instruction to swap the instruction set to ARM which will likely cause a crash.  To fix this, we introduce the <code>long_call</code> compilation attribute:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">BoxPokemon </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">__attribute__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">long_call</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">DaycareMon_GetBoxMon</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DaycareMon </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dcmon</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>This tricks the compiler to elicit code that will not cull the thumb bit from the function address and properly jump to it.  You can define this as a macro, i.e. <code>LONG_CALL</code>, which would allow this declaration to look like this:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">LONG_CALL</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">__attribute__</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">long_call</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BoxPokemon </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> LONG_CALL </span><span class="token function" style="color:#d73a49">DaycareMon_GetBoxMon</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DaycareMon </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dcmon</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><code>DaycareMon_GetBoxMon</code> can then be used in the code that you write as any other function.  The linker will resolve its address properly and the code will function as it is in the original ROM.  This is useful for copying existing functions from the ROM without needing to copy copious amounts of code from the decompilations or manually reimplement in assembly.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="code-injection-template">Code Injection Template<a href="#code-injection-template" class="hash-link" aria-label="Direct link to Code Injection Template" title="Direct link to Code Injection Template" translate="no">​</a></h2>
<p>For those who don&#x27;t want to fully overhaul the battle system of their hacks, the <a href="https://github.com/BluRosie/hg-transparent-textbox" target="_blank" rel="noopener noreferrer">repository for transparent textboxes</a> serves as a template for code injection.  It still uses <a href="https://pokehacking.com/tutorials/ramexpansion/" target="_blank" rel="noopener noreferrer">Mikelan and Nomura&#x27;s synthetic overlay approach</a> to code expansion, where an unused file in the file system is repurposed as a code storage container instead of directly using another overlay as is necessary for larger code injection projects with sizes that surpass the RAM size limitations afforded by this approach.  It is still completely valid for entire projects--0x18000 bytes is quite a lot, and anything but entire engine overhauls is supported by this.</p>
<p>Its <code>Makefile</code> has an example of a NARC being edited with files that are present in the repository.  <a href="https://github.com/BluRosie/hg-transparent-textbox/blob/main/Makefile#L87" target="_blank" rel="noopener noreferrer">These</a> <a href="https://github.com/BluRosie/hg-transparent-textbox/blob/main/Makefile#L97-L106" target="_blank" rel="noopener noreferrer">lines</a> (there are two links there, lines 87 and 97-106) can be deleted in the event that you don&#x27;t want to use the transparent textboxes that are implemented by the repository.  This will then also involve deleting the code that is present to handle the transparent textboxes--clearing out the <code>src</code> directory and the <code>asm/other_hooks.s</code>, <code>repoints</code>, <code>bytereplacement</code>, and <code>hooks</code> files will leave the repository blank for your populating.</p>
<p>From there, adding new files in <code>src</code> will automatically compile them and link everything for insertion.  Same goes for assembly source files in <code>asm</code>.  <a href="https://github.com/BluRosie/hg-transparent-textbox/blob/main/asm/thumb_help.s" target="_blank" rel="noopener noreferrer"><code>asm/thumb_help.s</code></a> is a file that implements some functions that the C compiler sometimes assumes exists and uses as functions.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ds-pokemon-hacking/ds-pokemon-hacking.github.io/docs/generation-iv/guides/hgss-code_injection/hgss-code_injection.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_VsjB"></div></div></footer></article><nav class="pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/generation-iv/guides/hgss-a3i5_a5i3_materials_and_darkness/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Translucent Textures with Darkness Weather</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/generation-iv/guides/hgss-new_overworlds/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Adding New Overworlds in HeartGold Engine</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#table-of-contents" class="table-of-contents__link toc-highlight">Table of Contents</a></li><li><a href="#manual-process" class="table-of-contents__link toc-highlight">Manual Process</a></li><li><a href="#shortcomings-of-the-manual-process" class="table-of-contents__link toc-highlight">Shortcomings of the Manual Process</a></li><li><a href="#implementation-details" class="table-of-contents__link toc-highlight">Implementation Details</a><ul><li><a href="#hooks" class="table-of-contents__link toc-highlight"><code>hooks</code></a></li><li><a href="#bytereplacement" class="table-of-contents__link toc-highlight"><code>bytereplacement</code></a></li><li><a href="#routinepointers" class="table-of-contents__link toc-highlight"><code>routinepointers</code></a></li><li><a href="#repoints" class="table-of-contents__link toc-highlight"><code>repoints</code></a></li></ul></li><li><a href="#code-injection-template" class="table-of-contents__link toc-highlight">Code Injection Template</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 DS Pokémon Hacking. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>